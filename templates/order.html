{% extends "base.html" %}

{% block title %}Поръчка - Книжарница{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Завършване на поръчка</h2>
    </div>
    
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Вашата кошница</h5>
            </div>
            <div class="card-body" id="cartContainer">
                <div class="alert alert-info">
                    Зареждане на съдържанието на кошницата...
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Данни за доставка</h5>
            </div>
            <div class="card-body">
                <form id="orderForm">
                    <!-- Секция за лични данни -->
                    <h6 class="mb-3">Лични данни</h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="fullName" class="form-label">Пълно име</label>
                            <input type="text" class="form-control" id="fullName" name="full_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">Имейл</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="phone" class="form-label">Телефон</label>
                        <input type="tel" class="form-control" id="phone" name="phone" required>
                    </div>
                    
                    <!-- Секция за адрес на доставка -->
                    <h6 class="mb-3 mt-4">Адрес за доставка</h6>
                    
                    <div class="mb-3">
                        <label for="city" class="form-label">Град/Населено място</label>
                        <input type="text" class="form-control" id="city" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="postCode" class="form-label">Пощенски код</label>
                        <input type="text" class="form-control" id="postCode" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">Адрес</label>
                        <textarea class="form-control" id="address" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="additionalInfo" class="form-label">Допълнителна информация (незадължително)</label>
                        <textarea class="form-control" id="additionalInfo" rows="2"></textarea>
                    </div>
                    
                    <!-- Секция за начин на плащане -->
                    <h6 class="mb-3 mt-4">Начин на плащане</h6>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" value="cash" checked>
                            <label class="form-check-label" for="cashOnDelivery">
                                Наложен платеж
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cardPayment" value="card">
                            <label class="form-check-label" for="cardPayment">
                                Плащане с карта
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="bank">
                            <label class="form-check-label" for="bankTransfer">
                                Банков превод
                            </label>
                        </div>
                    </div>
                    
                    <!-- Бележки към поръчката -->
                    <div class="mb-3">
                        <label for="orderNotes" class="form-label">Бележки към поръчката (незадължително)</label>
                        <textarea class="form-control" id="orderNotes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <!-- Политика за поверителност -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="privacyPolicy" required>
                        <label class="form-check-label" for="privacyPolicy">
                            Съгласен съм с <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Политиката за поверителност</a>
                        </label>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary">Завърши поръчката</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card cart-summary mb-4" id="cartSummary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Обобщение на поръчката</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Сума:</span>
                    <span id="cartSubtotal">0.00 лв.</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Доставка:</span>
                    <span id="shippingCost">5.00 лв.</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Общо:</span>
                    <span id="cartTotal">0.00 лв.</span>
                </div>
                
                <div class="mt-3">
                    <p class="mb-1"><i class="fas fa-truck me-2"></i> Доставка до 3-5 работни дни</p>
                    <p class="mb-1"><i class="fas fa-shield-alt me-2"></i> Сигурни плащания</p>
                    <p class="mb-0"><i class="fas fa-undo me-2"></i> 14-дневно право на връщане</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Имате въпроси?</h5>
            </div>
            <div class="card-body">
                <p>Нашият екип е на разположение да ви помогне с всякакви въпроси относно вашата поръчка.</p>
                <p class="mb-1"><i class="fas fa-phone me-2"></i> +359 88 888 8888</p>
                <p class="mb-0"><i class="fas fa-envelope me-2"></i> orders@bookshop.bg</p>
            </div>
        </div>
    </div>
</div>

<!-- Модален прозорец за политиката за поверителност -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="privacyModalLabel">Политика за поверителност</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>1. Събиране на информация</h6>
                <p>Събираме лична информация, като име, адрес, имейл адрес и телефонен номер, когато доброволно ни я предоставите при регистрация, поръчка или попълване на формуляри на нашия уебсайт.</p>
                
                <h6>2. Използване на информацията</h6>
                <p>Използваме събраната информация, за да обработваме поръчки, да изпращаме информация за вашите поръчки, да отговаряме на запитвания и да подобряваме вашето преживяване на нашия уебсайт.</p>
                
                <h6>3. Защита на информацията</h6>
                <p>Ние сме ангажирани да защитаваме вашата лична информация и използваме различни мерки за сигурност, за да гарантираме нейната защита.</p>
                
                <h6>4. Споделяне на информация</h6>
                <p>Няма да продаваме, разменяме или прехвърляме по друг начин вашата лична информация на трети страни без вашето съгласие, освен когато е необходимо за изпълнение на поръчка (напр. куриерски услуги).</p>
                
                <h6>5. Бисквитки</h6>
                <p>Нашият уебсайт използва "бисквитки", за да подобри вашето преживяване. Можете да настроите вашия браузър да отказва бисквитки, но това може да ограничи някои функционалности на нашия уебсайт.</p>
                
                <h6>6. Промени в политиката за поверителност</h6>
                <p>Можем да актуализираме нашата политика за поверителност от време на време. Промените ще бъдат публикувани на тази страница.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Разбрах</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Зареждане на данни за кошницата
        renderCart();
        
        // Попълване на данни за потребителя, ако е влязъл
        if (currentUser) {
            document.getElementById('fullName').value = currentUser.full_name || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('phone').value = currentUser.phone || '';
        }
        
        // Обработчик за формата за поръчка
        const orderForm = document.getElementById('orderForm');
        
        orderForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Проверка за празна кошница
            if (cart.length === 0) {
                showToast('Грешка', 'Кошницата е празна', 'error');
                return;
            }
            
            // Проверка дали условията са приети
            const privacyPolicy = document.getElementById('privacyPolicy').checked;
            if (!privacyPolicy) {
                showToast('Грешка', 'Трябва да приемете политиката за поверителност', 'error');
                return;
            }
            
            // Създаваме обект с данните за доставка
            const shippingAddress = {
                city: document.getElementById('city').value,
                postCode: document.getElementById('postCode').value,
                address: document.getElementById('address').value,
                additionalInfo: document.getElementById('additionalInfo').value
            };
            
            // Съставяме данните за поръчката
            const orderData = new FormData();
            orderData.append('full_name', document.getElementById('fullName').value);
            orderData.append('email', document.getElementById('email').value);
            orderData.append('phone', document.getElementById('phone').value);
            orderData.append('shipping_address', JSON.stringify(shippingAddress));
            orderData.append('payment_method', document.querySelector('input[name="paymentMethod"]:checked').value);
            orderData.append('notes', document.getElementById('orderNotes').value);
            
            // Добавяме артикулите от кошницата
            const items = cart.map(item => ({
                book_id: item.bookId,
                quantity: item.quantity
            }));
            orderData.append('items', JSON.stringify(items));
            
            try {
                // Показваме потвърждение
                showConfirmDialog('Потвърждение на поръчка', 'Сигурни ли сте, че искате да завършите поръчката?', async function() {
                    try {
                        // Изпращаме заявка към API
                        const endpoint = currentUser ? '/api/orders' : '/api/guest-orders';
                        
                        const response = await fetchWithToken(endpoint, {
                            method: 'POST',
                            body: orderData
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.detail || 'Грешка при създаване на поръчка');
                        }
                        
                        // Изчистваме кошницата
                        clearCart();
                        
                        // Показваме съобщение за успех
                        showToast('Успех', 'Поръчката е създадена успешно', 'success');
                        
                        // Пренасочваме към началната страница или към страницата с поръчки
                        setTimeout(() => {
                            if (currentUser) {
                                window.location.href = '/orders';
                            } else {
                                window.location.href = '/';
                            }
                        }, 2000);
                    } catch (error) {
                        console.error('Order error:', error);
                        showToast('Грешка', error.message, 'error');
                    }
                });
            } catch (error) {
                console.error('Order error:', error);
                showToast('Грешка', error.message, 'error');
            }
        });
        
        // Функция за обновяване на сумите
        function updateTotals() {
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const shipping = subtotal > 0 ? 5.00 : 0;
            const total = subtotal + shipping;
            
            document.getElementById('cartSubtotal').textContent = formatPrice(subtotal);
            document.getElementById('shippingCost').textContent = formatPrice(shipping);
            document.getElementById('cartTotal').textContent = formatPrice(total);
        }
        
        // Функция за рендериране на кошницата
        function renderCart() {
            const cartContainer = document.getElementById('cartContainer');
            
            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="alert alert-info">
                        Кошницата е празна. <a href="/search">Разгледайте нашите книги</a>.
                    </div>
                `;
                
                document.getElementById('cartSummary').classList.add('d-none');
                return;
            }
            
            let html = '';
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                
                html += `
                    <div class="cart-item mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="/static/book-placeholder.jpg" class="img-fluid" alt="${item.title}">
                            </div>
                            <div class="col-md-5">
                                <h6>${item.title}</h6>
                                <p class="text-primary mb-0">${formatPrice(item.price)}</p>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" type="button" onclick="updateCartItemQuantity(${item.bookId}, ${item.quantity - 1})">-</button>
                                    <input type="number" class="form-control text-center" value="${item.quantity}" min="1" onchange="updateCartItemQuantity(${item.bookId}, parseInt(this.value) || 1)">
                                    <button class="btn btn-outline-secondary" type="button" onclick="updateCartItemQuantity(${item.bookId}, ${item.quantity + 1})">+</button>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <p class="fw-bold mb-0">${formatPrice(itemTotal)}</p>
                                <button class="btn btn-sm btn-outline-danger mt-1" onclick="removeFromCart(${item.bookId})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            cartContainer.innerHTML = html;
            
            document.getElementById('cartSummary').classList.remove('d-none');
            updateTotals();
        }
    });
</script>
{% endblock %}
